<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DinnuPixels</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="manifest" href="manifest.json" />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      .btn-loader-small {
        width: 16px;
        height: 16px;
        border-width: 2px;
        border-top-color: #fff;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      /* Hide default file input */
      input[type="file"] {
        display: none;
      }
      /* Toggle Switch Styles */
      .toggle-checkbox:checked + .toggle-label .toggle-dot {
        transform: translateX(100%);
      }
      .toggle-checkbox:checked + .toggle-label .toggle-bg {
        background-color: #2563eb; /* blue-600 */
      }
    </style>
  </head>
  <body
    class="bg-gray-900 text-white flex justify-center items-start min-h-screen p-4"
  >
    <div
      class="w-full max-w-2xl bg-gray-800 rounded-2xl shadow-lg p-6 md:p-8 my-8"
    >
      <h1 class="text-2xl md:text-3xl font-bold text-center mb-4 text-gray-100">
        DinnuPixels
      </h1>

      <!-- Image Upload Section -->
      <fieldset id="settingsFieldset">
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-300 mb-2"
            >Reference Image (Optional)</label
          >
          <div class="flex items-center space-x-4">
            <label
              for="imageUpload"
              class="cursor-pointer bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200"
            >
              Choose File
            </label>
            <input
              type="file"
              id="imageUpload"
              accept="image/png, image/jpeg"
            />
            <div
              id="referenceImageContainer"
              class="w-16 h-16 bg-gray-700 rounded-lg flex-shrink-0 overflow-hidden"
              style="display: none"
            >
              <img
                id="referenceImage"
                src=""
                alt="Reference"
                class="w-full h-full object-cover"
              />
            </div>
            <span id="fileName" class="text-gray-400 truncate"
              >No file chosen</span
            >
            <button
              id="cancelImageBtn"
              class="text-gray-400 hover:text-white"
              style="display: none"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
        </div>

        <!-- Main Prompt Input -->
        <div class="mb-6">
          <div class="flex justify-between items-center mb-2">
            <label for="prompt" class="block text-sm font-medium text-gray-300"
              >Main Prompt</label
            >
          </div>
          <div class="relative">
            <textarea
              id="prompt"
              rows="5"
              class="w-full p-3 pr-10 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow duration-200 text-gray-200 resize-none"
              placeholder="Start with a word, end with a masterpieceâ€”DinnuPixels brings your vision to life."
            ></textarea>
            <button
              id="clearPromptBtn"
              class="absolute top-3 right-3 text-gray-400 hover:text-white"
              title="Clear text"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
        </div>

        <!-- Watermark Section -->
        <div class="mb-6">
          <div class="flex justify-between items-center mb-2">
            <label for="watermarkName" class="text-sm font-medium text-gray-300"
              >Watermark</label
            >
            <label
              for="watermarkToggle"
              class="flex items-center cursor-pointer"
            >
              <div class="relative">
                <input
                  type="checkbox"
                  id="watermarkToggle"
                  class="sr-only toggle-checkbox"
                  checked
                />
                <div class="toggle-label flex items-center">
                  <div
                    class="toggle-bg block bg-gray-600 w-14 h-8 rounded-full transition-colors"
                  ></div>
                  <div
                    class="toggle-dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition-transform"
                  ></div>
                </div>
              </div>
            </label>
          </div>
          <input
            type="text"
            id="watermarkName"
            class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-shadow duration-200 text-gray-200"
          />
        </div>

        <!-- Aspect Ratio Selection -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-300 mb-2"
            >Aspect Ratio</label
          >
          <div
            class="flex items-center justify-around bg-gray-700 rounded-lg p-1 h-10"
          >
            <label class="w-full text-center cursor-pointer">
              <input
                type="radio"
                name="aspectRatio"
                value="1:1"
                class="sr-only peer"
              />
              <span
                class="inline-block w-full p-2 rounded-md text-sm font-medium transition-colors peer-checked:bg-blue-600 peer-checked:text-white"
                >Square</span
              >
            </label>
            <label class="w-full text-center cursor-pointer">
              <input
                type="radio"
                name="aspectRatio"
                value="9:16"
                class="sr-only peer"
                checked
              />
              <span
                class="inline-block w-full p-2 rounded-md text-sm font-medium transition-colors peer-checked:bg-blue-600 peer-checked:text-white"
                >Portrait</span
              >
            </label>
            <label class="w-full text-center cursor-pointer">
              <input
                type="radio"
                name="aspectRatio"
                value="16:9"
                class="sr-only peer"
              />
              <span
                class="inline-block w-full p-2 rounded-md text-sm font-medium transition-colors peer-checked:bg-blue-600 peer-checked:text-white"
                >Landscape</span
              >
            </label>
          </div>
        </div>

        <!-- Settings Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <!-- Image Count -->
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2"
              >Images per Cycle (Max 4)</label
            >
            <div
              class="flex items-center justify-center bg-gray-700 rounded-lg p-1 h-10 w-40 mx-auto"
            >
              <button
                id="minusBtn"
                class="px-4 py-1 text-lg font-bold text-white rounded-md hover:bg-gray-600"
              >
                -
              </button>
              <span id="imageCountDisplay" class="px-4 text-lg">1</span>
              <button
                id="plusBtn"
                class="px-4 py-1 text-lg font-bold text-white rounded-md hover:bg-gray-600"
              >
                +
              </button>
            </div>
          </div>
          <!-- Loop Count -->
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2"
              >Loop Count</label
            >
            <div
              class="flex items-center justify-center bg-gray-700 rounded-lg p-1 h-10 w-40 mx-auto"
            >
              <button
                id="loopMinusBtn"
                class="px-4 py-1 text-lg font-bold text-white rounded-md hover:bg-gray-600"
              >
                -
              </button>
              <span id="loopCountDisplay" class="px-4 text-lg">1</span>
              <button
                id="loopPlusBtn"
                class="px-4 py-1 text-lg font-bold text-white rounded-md hover:bg-gray-600"
              >
                +
              </button>
            </div>
          </div>
        </div>

        <!-- Auto Download Toggle -->
        <div class="mb-6">
          <label
            for="autoDownloadToggle"
            class="block text-sm font-medium text-gray-300 mb-2 text-center"
            >Auto Download</label
          >
          <div class="flex items-center justify-center h-10">
            <label
              for="autoDownloadToggle"
              class="flex items-center cursor-pointer"
            >
              <div class="relative">
                <input
                  type="checkbox"
                  id="autoDownloadToggle"
                  class="sr-only toggle-checkbox"
                />
                <div class="toggle-label flex items-center">
                  <div
                    class="toggle-bg block bg-gray-600 w-14 h-8 rounded-full transition-colors"
                  ></div>
                  <div
                    class="toggle-dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition-transform"
                  ></div>
                </div>
              </div>
            </label>
          </div>
        </div>
      </fieldset>

      <!-- Generate Button -->
      <button
        id="generateBtn"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-800 flex items-center justify-center"
      >
        <span id="generateBtnContent">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="mr-2 inline-block"
          >
            <path
              d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"
            ></path>
            <path d="M5 3v4"></path>
            <path d="M19 17v4"></path>
            <path d="M3 5h4"></path>
            <path d="M17 19h4"></path>
          </svg>
          Generate Image
        </span>
      </button>

      <!-- Status and Results -->
      <p
        id="loopStatus"
        class="text-center text-yellow-400 mt-4 font-medium"
        style="display: none"
      ></p>
      <div id="resultsGrid" class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Images will be injected here -->
      </div>
      <p
        id="errorMessage"
        class="text-red-400 text-center mt-4"
        style="display: none"
      ></p>
      <div
        id="mainLoader"
        class="w-full flex justify-center mt-8"
        style="display: none"
      >
        <div class="loader"></div>
      </div>
    </div>

    <script>
      // UI Elements
      const settingsFieldset = document.getElementById("settingsFieldset");
      const promptTextarea = document.getElementById("prompt");
      const watermarkNameInput = document.getElementById("watermarkName");
      const watermarkToggle = document.getElementById("watermarkToggle");
      const autoDownloadToggle = document.getElementById("autoDownloadToggle");
      const clearPromptBtn = document.getElementById("clearPromptBtn");
      const generateBtn = document.getElementById("generateBtn");
      const generateBtnContent = document.getElementById("generateBtnContent");
      const resultsGrid = document.getElementById("resultsGrid");
      const errorMessage = document.getElementById("errorMessage");
      const mainLoader = document.getElementById("mainLoader");
      const imageUpload = document.getElementById("imageUpload");
      const referenceImageContainer = document.getElementById(
        "referenceImageContainer"
      );
      const referenceImage = document.getElementById("referenceImage");
      const fileNameSpan = document.getElementById("fileName");
      const cancelImageBtn = document.getElementById("cancelImageBtn");
      const imageCountDisplay = document.getElementById("imageCountDisplay");
      const minusBtn = document.getElementById("minusBtn");
      const plusBtn = document.getElementById("plusBtn");
      const loopCountDisplay = document.getElementById("loopCountDisplay");
      const loopMinusBtn = document.getElementById("loopMinusBtn");
      const loopPlusBtn = document.getElementById("loopPlusBtn");
      const loopStatus = document.getElementById("loopStatus");
      const improveBtn = document.getElementById("improveBtn");
      const surpriseBtn = document.getElementById("surpriseBtn");

      // State variables
      let referenceImageData = null;
      let currentImageCount = 1;
      let currentLoopCount = 1;
      let isLooping = false;
      const MAX_IMAGES = 4;

      // Initialize
      watermarkNameInput.value = "DinnuBunny";
      clearPromptBtn.addEventListener("click", () => {
        promptTextarea.value = "";
      });

      // Stepper Logic
      plusBtn.addEventListener("click", () => {
        if (currentImageCount < MAX_IMAGES)
          imageCountDisplay.textContent = ++currentImageCount;
      });
      minusBtn.addEventListener("click", () => {
        if (currentImageCount > 1)
          imageCountDisplay.textContent = --currentImageCount;
      });
      loopPlusBtn.addEventListener("click", () => {
        loopCountDisplay.textContent = ++currentLoopCount;
      });
      loopMinusBtn.addEventListener("click", () => {
        if (currentLoopCount > 1)
          loopCountDisplay.textContent = --currentLoopCount;
      });

      function removeReferenceImage() {
        imageUpload.value = null;
        referenceImageData = null;
        referenceImage.src = "";
        referenceImageContainer.style.display = "none";
        fileNameSpan.textContent = "No file chosen";
        cancelImageBtn.style.display = "none";
      }

      imageUpload.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (!file) {
          removeReferenceImage();
          return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
          referenceImageData = {
            mimeType: file.type,
            data: e.target.result.split(",")[1],
          };
          referenceImage.src = e.target.result;
          referenceImageContainer.style.display = "block";
          fileNameSpan.textContent = file.name;
          cancelImageBtn.style.display = "inline-block";
        };
        reader.readAsDataURL(file);
      });

      cancelImageBtn.addEventListener("click", removeReferenceImage);

      document
        .querySelectorAll('input[name="aspectRatio"]')
        .forEach((radio) => {
          radio.addEventListener("change", () => {
            document
              .querySelectorAll('input[name="aspectRatio"] + span')
              .forEach((span) => span.classList.remove("bg-blue-600"));
            if (radio.checked) {
              radio.nextElementSibling.classList.add("bg-blue-600");
            }
          });
        });
      document
        .querySelector('input[name="aspectRatio"]:checked')
        .nextElementSibling.classList.add("bg-blue-600");

      function toggleButtonLoading(button, isLoading) {
        const text = button.querySelector(".btn-text");
        const loader = button.querySelector(".loader");
        if (isLoading) {
          text.style.display = "none";
          loader.style.display = "inline-block";
          button.disabled = true;
        } else {
          text.style.display = "inline-block";
          loader.style.display = "none";
          button.disabled = false;
        }
      }

      async function callGeminiTextAPI(prompt) {
        const apiKey = ""; // API key will be injected by the environment
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const payload = {
          contents: [{ parts: [{ text: prompt }] }],
        };

        try {
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
          }
          const data = await response.json();
          return data.candidates[0].content.parts[0].text;
        } catch (error) {
          console.error("Gemini Text API call failed:", error);
          errorMessage.textContent =
            "Failed to call Gemini AI. Please try again.";
          errorMessage.style.display = "block";
          return null;
        }
      }

      improveBtn.addEventListener("click", async () => {
        const currentPrompt = promptTextarea.value.trim();
        if (!currentPrompt) {
          errorMessage.textContent = "Please enter a prompt to improve.";
          errorMessage.style.display = "block";
          return;
        }
        toggleButtonLoading(improveBtn, true);
        const systemPrompt = `You are an expert prompt engineer. Take the user's idea and expand it into a rich, detailed, and visually descriptive prompt for an AI image generator. Focus on composition, lighting, style, and mood. The idea is: "${currentPrompt}"`;
        const improvedPrompt = await callGeminiTextAPI(systemPrompt);
        if (improvedPrompt) {
          promptTextarea.value = improvedPrompt;
        }
        toggleButtonLoading(improveBtn, false);
      });

      surpriseBtn.addEventListener("click", async () => {
        toggleButtonLoading(surpriseBtn, true);
        const systemPrompt =
          "Generate a single, random, creative, and visually detailed prompt for an advanced AI image generator. The prompt should describe a unique scene, character, or concept.";
        const randomPrompt = await callGeminiTextAPI(systemPrompt);
        if (randomPrompt) {
          promptTextarea.value = randomPrompt;
        }
        toggleButtonLoading(surpriseBtn, false);
      });

      function setUiState(isGenerating) {
        settingsFieldset.disabled = isGenerating;
        if (isGenerating) {
          generateBtn.classList.remove("bg-blue-600", "hover:bg-blue-700");
          generateBtn.classList.add("bg-red-600", "hover:bg-red-700");
          generateBtnContent.innerHTML = "Stop";
          mainLoader.style.display = "flex";
        } else {
          generateBtn.classList.add("bg-blue-600", "hover:bg-blue-700");
          generateBtn.classList.remove("bg-red-600", "hover:bg-red-700");
          generateBtnContent.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 inline-block"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg> Generate Image`;
          mainLoader.style.display = "none";
          loopStatus.style.display = "none";
        }
      }

      async function startGenerationLoop() {
        isLooping = true;
        setUiState(true);

        // Re-enable the form if it's just a single run
        if (currentLoopCount === 1) {
          settingsFieldset.disabled = false;
        }

        const mainPrompt = promptTextarea.value.trim();
        const aspectRatio = document.querySelector(
          'input[name="aspectRatio"]:checked'
        ).value;
        let combinedPrompt = mainPrompt;

        if (watermarkToggle.checked) {
          const watermarkName = watermarkNameInput.value.trim();
          if (watermarkName) {
            const watermarkText = `and a small elegant text watermark reading "${watermarkName}" placed in the bottom right corner with some padding in the bottom, subtle, semi-transparent, blending harmoniously with the background.`;
            combinedPrompt = `${mainPrompt} ${watermarkText}`.trim();
          }
        }

        if (!mainPrompt) {
          errorMessage.textContent = "Please enter a prompt.";
          errorMessage.style.display = "block";
          isLooping = false;
          setUiState(false);
          return;
        }

        // Clear the grid only at the start of the entire loop process
        resultsGrid.innerHTML = "";
        errorMessage.style.display = "none";

        for (let i = 1; i <= currentLoopCount; i++) {
          if (!isLooping) {
            loopStatus.textContent = "Loop stopped by user.";
            break;
          }

          loopStatus.style.display = "block";
          loopStatus.textContent = `Running Cycle ${i} of ${currentLoopCount}...`;

          try {
            const results = await generateImageWithExponentialBackoff(
              combinedPrompt,
              aspectRatio,
              currentImageCount,
              referenceImageData
            );
            if (results && results.length > 0) {
              results.forEach((base64Data) => {
                if (base64Data) {
                  const imageUrl = `data:image/png;base64,${base64Data}`;
                  createImageCard(imageUrl);
                  if (autoDownloadToggle.checked) {
                    triggerDownload(imageUrl);
                  }
                }
              });
            } else {
              throw new Error("Image generation failed in this cycle.");
            }
          } catch (error) {
            console.error("Error in generation cycle:", error);
            errorMessage.textContent = error.message;
            errorMessage.style.display = "block";
            break; // Stop the loop on error
          }
        }

        if (isLooping) loopStatus.textContent = "Loop finished.";
        isLooping = false;
        setUiState(false);
      }

      generateBtn.addEventListener("click", async () => {
        if (isLooping) {
          isLooping = false; // Signal the loop to stop
        } else {
          try {
            await startGenerationLoop();
          } catch (e) {
            console.error("Caught unhandled error in event listener:", e);
            errorMessage.textContent =
              "An unexpected error occurred. Please check the console.";
            errorMessage.style.display = "block";
            // Ensure UI is reset in case of a catastrophic failure
            isLooping = false;
            setUiState(false);
          }
        }
      });

      function triggerDownload(imageUrl) {
        const link = document.createElement("a");
        link.href = imageUrl;
        link.download = `generated-image-${Date.now()}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function createImageCard(imageUrl) {
        const card = document.createElement("div");
        card.className = "bg-gray-700 rounded-lg p-2 text-center";
        const img = document.createElement("img");
        img.src = imageUrl;
        img.className = "w-full h-auto rounded-md object-contain";
        const downloadBtn = document.createElement("button");
        downloadBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> Download`;
        downloadBtn.className =
          "mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-800 flex items-center justify-center w-full";
        downloadBtn.addEventListener("click", () => triggerDownload(imageUrl));
        card.appendChild(img);
        card.appendChild(downloadBtn);
        resultsGrid.appendChild(card);
      }

      async function generateImageWithExponentialBackoff(
        prompt,
        aspectRatio,
        count,
        imageData
      ) {
        const apiKey = "AIzaSyCHb4vCqbJXKmtZ7JQ3yjCfUHOgX1MDBL4";
        if (imageData) {
          const promises = Array.from({ length: count }, () => {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-preview-image-generation:generateContent?key=${apiKey}`;
            const payload = {
              contents: [
                {
                  parts: [
                    { text: prompt },
                    {
                      inlineData: {
                        mimeType: imageData.mimeType,
                        data: imageData.data,
                      },
                    },
                  ],
                },
              ],
              generationConfig: { responseModalities: ["TEXT", "IMAGE"] },
            };
            return makeApiCall(apiUrl, payload, true);
          });
          return Promise.all(promises);
        } else {
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
          const payload = {
            instances: [{ prompt: prompt }],
            parameters: { sampleCount: count, aspectRatio: aspectRatio },
          };
          return makeApiCall(apiUrl, payload, false);
        }
      }

      async function makeApiCall(apiUrl, payload, isImageToImage) {
        let delay = 1000;
        const maxRetries = 5;
        for (let i = 0; i < maxRetries; i++) {
          try {
            const response = await fetch(apiUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            if (response.ok) {
              const result = await response.json();
              if (isImageToImage) {
                const base64Data =
                  result?.candidates?.[0]?.content?.parts?.find(
                    (p) => p.inlineData
                  )?.inlineData?.data;
                if (base64Data) return base64Data;
              } else {
                const predictions = result.predictions;
                if (predictions && predictions.length > 0) {
                  return predictions.map((p) => p.bytesBase64Encoded);
                }
              }
              throw new Error(
                "The model did not return an image. This might be due to safety filters."
              );
            } else if (response.status === 429 || response.status >= 500) {
              console.warn(
                `Attempt ${i + 1} with status ${response.status}. Retrying...`
              );
              if (i < maxRetries - 1)
                await new Promise((resolve) =>
                  setTimeout(resolve, (delay *= 2))
                );
            } else {
              const errorText = await response.text();
              throw new Error(
                `API request failed with status ${response.status}: ${errorText}`
              );
            }
          } catch (error) {
            if (i === maxRetries - 1) throw error;
            console.warn(
              `Attempt ${i + 1} failed: ${error.message}. Retrying...`
            );
            await new Promise((resolve) => setTimeout(resolve, (delay *= 2)));
          }
        }
        throw new Error("Image generation failed after multiple retries.");
      }

      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker.register("/sw.js").then(
            (registration) => {
              console.log(
                "ServiceWorker registration successful with scope: ",
                registration.scope
              );
            },
            (err) => {
              console.log("ServiceWorker registration failed: ", err);
            }
          );
        });
      }
    </script>
  </body>
</html>
